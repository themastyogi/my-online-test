<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Online Test Web App</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">
    <style>
        html, body {
            font-family: 'Noto Sans Devanagari', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f3f6fa;
            color: #222;
            min-height: 100vh;
        }
        header {
            background: linear-gradient(90deg, #4a90e2 0%, #357ab8 100%);
            color: #fff;
            padding: 1.2rem 0.5rem 1.2rem 0.5rem;
            text-align: center;
            letter-spacing: 1px;
            font-size: 1.5rem;
            font-weight: 600;
            box-shadow: 0 2px 6px #0001;
        }
        nav {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 100;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 0.5rem 0.5rem 0.5rem;
            box-shadow: 0 2px 8px #0001;
        }
        nav button {
            margin: 0;
            padding: 0.7rem 1.4rem;
            border: none;
            background: linear-gradient(90deg, #4a90e2 0%, #357ab8 100%);
            color: #fff;
            border-radius: 24px;
            cursor: pointer;
            font-size: 1.08rem;
            font-weight: 500;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 6px #4a90e222;
        }
        nav button:hover, nav button:active, nav button:focus {
            background: linear-gradient(90deg, #357ab8 0%, #4a90e2 100%);
            transform: scale(1.05);
            outline: none;
        }
        main {
            max-width: 98vw;
            width: 100%;
            box-sizing: border-box;
            margin: 2rem auto;
            background: #fff;
            padding: 2rem 2.5vw;
            border-radius: 14px;
            box-shadow: 0 2px 16px rgba(74,144,226,0.07);
            min-height: 70vh;
        }
        .page-section {
            display: block;
            width: 100%;
        }
        input[type="text"], input[type="password"], input[type="number"], select, textarea {
            width: 100%;
            padding: 0.7rem 0.9rem;
            margin: 0.4rem 0 1rem 0;
            border: 1px solid #c7d0db;
            border-radius: 6px;
            font-size: 1rem;
            background: #f7fafd;
            transition: border 0.2s;
        }
        input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            border: 1.5px solid #4a90e2;
            outline: none;
            background: #fff;
        }
        label {
            font-weight: 500;
            margin-bottom: 0.2rem;
            display: block;
        }
        #question-container {
            margin-top: 1rem;
        }
        /* Improved option layout for questions */
        .question-options {
            margin: 1.2em 0 0.5em 0;
            padding: 1em 1em 1em 0.5em;
            background: #f8fbff;
            border-radius: 8px;
            box-shadow: 0 1px 4px #4a90e208;
        }
        .option-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.7em;
            font-size: 1.08em;
        }
        .option-row:last-child {
            margin-bottom: 0;
        }
        .option-row input[type="radio"] {
            margin-right: 0.7em;
            accent-color: #4a90e2;
            width: 1.1em;
            height: 1.1em;
        }
        #question-container input[type="radio"] {
            margin-right: 0.5em;
            accent-color: #4a90e2;
            width: 1.1em;
            height: 1.1em;
        }
        .test-nav-btns {
            display: flex;
            gap: 0.6rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        .test-nav-btns button {
            padding: 0.5em 1.2em;
            border-radius: 20px;
            font-size: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.2rem;
            font-size: 0.99rem;
        }
        th, td {
            padding: 0.7em 0.5em;
            border: 1px solid #e0e6ef;
            text-align: left;
            vertical-align: top;
        }
        th {
            background: #f0f6ff;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #f8fbff;
        }
        .actions button {
            margin-right: 0.4em;
            font-size: 0.95em;
        }
        .admin-section, .test-section, .profile-section, .subject-section {
            width: 100%;
        }
        #admin-login-modal {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.35);
            z-index: 1000;
        }
        #admin-login-modal > div {
            background: #fff;
            padding: 2rem 1.2rem;
            border-radius: 12px;
            max-width: 320px;
            width: 92vw;
            margin: auto;
            box-shadow: 0 2px 10px #0002;
        }
        .status, #admin-login-status, #admin-eval-status, #manual-add-status, #upload-status {
            color: #e74c3c;
            margin-top: 0.7rem;
            font-size: 0.98em;
        }
        .success {
            color: #27ae60;
        }
        /* Responsive adjustments */
        @media (max-width: 700px) {
            main {
                padding: 0.7rem 0.2rem;
                margin: 0.2rem;
                border-radius: 7px;
            }
            nav {
                flex-wrap: wrap;
                gap: 0.2rem;
                padding: 0.4rem 0.1rem;
            }
            nav button {
                font-size: 0.97rem;
                padding: 0.5rem 0.7rem;
                border-radius: 16px;
            }
            header {
                font-size: 1.1rem;
                padding: 0.7rem 0.2rem;
            }
            th, td {
                padding: 0.5em 0.3em;
                font-size: 0.97rem;
            }
            #admin-login-modal > div {
                padding: 1.2rem 0.5rem;
                max-width: 98vw;
            }
        }
        @media (max-width: 480px) {
            main {
                padding: 0.3rem 0.1rem;
                margin: 0.1rem;
                border-radius: 3px;
            }
            nav button {
                font-size: 0.92rem;
                padding: 0.4rem 0.6rem;
                border-radius: 12px;
            }
            th, td {
                font-size: 0.92rem;
            }
        }
        /* Make tables horizontally scrollable on mobile */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        table {
            min-width: 600px;
        }
        @media (max-width: 700px) {
            table {
                min-width: 420px;
            }
        }
        @media (max-width: 480px) {
            table {
                min-width: 340px;
            }
        }
        /* Misc */
        .center {
            text-align: center;
        }
        .mt-2 {
            margin-top: 2rem;
        }
        .mb-2 {
            margin-bottom: 2rem;
        }
        .flex {
            display: flex;
        }
        .flex-col {
            flex-direction: column;
        }
        .gap-1 {
            gap: 1rem;
        }
        .gap-2 {
            gap: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Online Test Web App</h1>
    </header>
    <nav style="margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem;">
        <button id="nav-profile">Profile</button>
        <button id="nav-subject">Select Subject</button>
        <button id="nav-test-history">Test History</button>
        <!-- Admin buttons can be added here, and will be hidden for non-admins -->
        <button id="nav-admin" style="display:none;">Admin</button>
        <button id="nav-view-questions" style="display:none;">View Questions</button>
        <div id="nav-user-info" style="margin-left:auto; font-size:0.98em; color:#357ab8; white-space:nowrap;"></div>
    </nav>

    <!-- Custom Admin Login Modal -->
    <div id="admin-login-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:2rem; border-radius:8px; max-width:300px; margin:auto; box-shadow:0 2px 10px #0003;">
        <h3>Admin Login</h3>
        <label>Username:<br><input type="text" id="admin-username"></label><br><br>
        <label>Password:<br><input type="password" id="admin-password"></label><br><br>
        <button id="admin-login-btn">Login</button>
        <button id="admin-cancel-btn" style="margin-left:1rem;">Cancel</button>
        <div id="admin-login-status" style="color:red; margin-top:1rem;"></div>
      </div>
    </div>
    <main>
        <section id="profile-section" class="page-section">
            <h2>User Profile</h2>
            <div id="profile-login" style="display:none;">
                <label for="profile-name-input"><b>Enter Your Name:</b></label>
                <input type="text" id="profile-name-input" placeholder="Your Name">
                <button id="profile-login-btn">Create Profile</button>
            </div>
            <div id="profile-info"></div>
            <button id="logout-btn" style="display:none;margin:1rem 0;">Logout</button>
            <div id="progress-report"></div>
            <div id="improvement-suggestions"></div>
        </section>
        <section id="subject-section" class="page-section" style="display:none;">
            <h2>Select Subject</h2>
            <label for="subject-select">Subject:</label>
            <select id="subject-select"></select>
            <label for="language-select" style="margin-left:1em;">Language:</label>
            <select id="language-select">
              <option value="en">English</option>
              <option value="hi">Hindi</option>
            </select>
            <h3>Select Evaluation Mode</h3>
            <select id="eval-mode-select">
                <option value="normal">Normal</option>
                <option value="negative">Negative Marking (Custom)</option>
                <option value="upsc">UPSC</option>
            </select>
            <button id="start-test-btn">Start Test</button>
        </section>
        <section id="test-section" class="page-section" style="display:none;">
            <h2>Test</h2>
            <div id="timer-display" style="font-weight:bold;margin-bottom:1rem;"></div>
            <div id="question-progress" style="margin-bottom:1rem;"></div>
            <div id="question-container"></div>
            <div id="test-nav-btns" style="margin-top:1rem;">
                <button id="prev-btn">Previous</button>
                <button id="skip-btn">Skip</button>
                <button id="save-next-btn">Save & Next</button>
                <button id="submit-test-btn" style="display:none;">Submit Test</button>
            </div>
        </section>
        <section id="view-questions-section" class="page-section" style="display:none;">
            <h2>All Uploaded Questions</h2>
            <label>Subject: <select id="view-questions-subject"></select></label>
            <div id="questions-table-container"></div>
        </section>
        <section id="test-history-section" class="page-section" style="display:none;">
            <h2>Test History</h2>
            <div id="test-history-list"></div>
            <div id="test-detail-container"></div>
        </section>
        <section id="admin-section" class="page-section" style="display:none;">
    <div style="text-align:right"><button id="admin-logout-btn" style="background:#e74c3c;color:#fff;border:none;padding:0.4em 1em;border-radius:4px;">Admin Logout</button></div>
            
            <h2>Admin - Upload Questions</h2>
            <input type="file" id="question-file-input" accept=".csv, .txt, .xlsx">
            <button id="upload-questions-btn">Upload</button>
            <button id="download-template-btn">Download Excel Template</button>
            <div id="upload-status"></div>
            <hr>
            <h3>Manual Question Entry</h3>
            <form id="manual-question-form">
                <label>Subject:
                    <select id="manual-subject-select"></select>
                </label><br><br>
                <label>Question:<br>
                    <input type="text" id="manual-question" required style="width:95%">
                </label><br><br>
                <label>Option A: <input type="text" id="manual-optionA" required></label><br>
                <label>Option B: <input type="text" id="manual-optionB" required></label><br>
                <label>Option C: <input type="text" id="manual-optionC" required></label><br>
                <label>Option D: <input type="text" id="manual-optionD" required></label><br>
                <label>Correct Answer:
                    <select id="manual-answer" required>
                        <option value="">Select</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </label><br><br>
                <label>Explanation (optional):<br>
                    <input type="text" id="manual-explanation" style="width:95%">
                </label><br><br>
                <button type="submit">Add Question</button>
                <span id="manual-add-status" style="margin-left:1rem;"></span>
            </form>
            <hr>
            <h3>Evaluation Settings</h3>
            <form id="admin-eval-form">
                <label>Test Duration (minutes): <input type="number" id="test-duration" value="30" min="1" style="width:60px;"> </label><br><br>
                <label>Negative Marking: Deduct <input type="number" id="neg-marks-deduct" value="1"> mark(s) for every <input type="number" id="neg-marks-count" value="3"> wrong answers.</label><br><br>
                <label>UPSC: +<input type="number" id="upsc-marks-correct" value="2"> for correct, -<input type="number" id="upsc-marks-wrong" value="0.66"> for wrong.</label><br><br>
                <button type="submit">Save</button>
                <span id="admin-eval-status" style="margin-left:1rem;"></span>
                <div id="admin-eval-summary"></div>
            </form>
        </section>
    </main>
    <script>
        // On page load, show profile creation if needed
        document.addEventListener('DOMContentLoaded', function() {
            let user = JSON.parse(localStorage.getItem('userProfile'));
            if (!user || !user.name) {
                showSection('profile');
                showProfileUI && showProfileUI();
            }
        });
        // Admin login state
        let isAdminLoggedIn = false;
        // Simple SPA navigation
        const sections = {
            profile: document.getElementById('profile-section'),
            subject: document.getElementById('subject-section'),
            test: document.getElementById('test-section'),
            admin: document.getElementById('admin-section'),
            'view-questions': document.getElementById('view-questions-section'),
            'test-history': document.getElementById('test-history-section')
        };
        function showSection(section) {
            // Prevent access to admin panel unless logged in as admin,
            // but if profile is 'themastyogi', allow direct access
            if (section === 'admin') {
                let user = JSON.parse(localStorage.getItem('userProfile'));
                if (!(isAdminLoggedIn || (user && user.name && user.name.toLowerCase() === 'themastyogi'))) {
                    document.getElementById('admin-login-modal').style.display = 'flex';
                    return;
                }
                // If profile is themastyogi, ensure admin features are visible
                if (user && user.name && user.name.toLowerCase() === 'themastyogi') {
                    isAdminLoggedIn = true;
                    document.getElementById('nav-view-questions').style.display = 'inline-block';
                }
            }
            Object.values(sections).forEach(sec => sec.style.display = 'none');
            sections[section].style.display = 'block';
            if (section === 'profile') {
                showProfileUI && showProfileUI();
                showOrPromptProfile && showOrPromptProfile();
            }
            if (section === 'view-questions') renderQuestionsTable && renderQuestionsTable();
            if (section === 'test-history') renderTestHistory && renderTestHistory();
        }
        document.getElementById('nav-profile').onclick = () => showSection('profile');
        document.getElementById('nav-subject').onclick = () => showSection('subject');
        // document.getElementById('nav-test').onclick = () => showSection('test');
        document.getElementById('nav-admin').onclick = function() {
    let user = JSON.parse(localStorage.getItem('userProfile'));
    if (user && user.name && user.name.toLowerCase() === 'themastyogi') {
        isAdminLoggedIn = true;
        document.getElementById('nav-view-questions').style.display = 'inline-block';
        showSection('admin');
        return;
    }
    // Always hide admin features until login
    document.getElementById('nav-view-questions').style.display = 'none';
    document.getElementById('admin-section').style.display = 'none';
    // Open admin login popup
    window.open('admin-login.html', 'AdminLogin', 'width=400,height=350,menubar=no,toolbar=no,location=no,status=no');
};
        window.adminLoginSuccess = function() {
            document.getElementById('nav-view-questions').style.display = 'inline-block';
            showSection('admin');
        };
        document.getElementById('admin-logout-btn').onclick = function() {
            document.getElementById('admin-section').style.display = 'none';
            document.getElementById('nav-view-questions').style.display = 'none';
        };




        // Hide admin features by default
        document.getElementById('nav-admin').style.display = 'inline-block';
        document.getElementById('nav-view-questions').style.display = 'none';
        document.getElementById('nav-view-questions').onclick = () => showSection('view-questions');
        document.getElementById('nav-test-history').onclick = () => showSection('test-history');

        // Admin logout button logic
        document.getElementById('admin-logout-btn').onclick = function() {
            isAdminLoggedIn = false;
            document.getElementById('admin-section').style.display = 'none';
            document.getElementById('nav-view-questions').style.display = 'none';
            document.getElementById('admin-login-modal').style.display = 'flex';
        };
        // User profile creation/login
        function showProfileUI() {
            let user = JSON.parse(localStorage.getItem('userProfile'));
            const loginDiv = document.getElementById('profile-login');
            const infoDiv = document.getElementById('profile-info');
            const logoutBtn = document.getElementById('logout-btn');
            // Check if user is 'themastyogi' and treat as admin
            if (user && user.name && user.name.toLowerCase() === 'themastyogi') {
                isAdminLoggedIn = true;
                document.getElementById('nav-admin').style.display = 'inline-block';
                document.getElementById('nav-view-questions').style.display = 'inline-block';
            } else {
                isAdminLoggedIn = false;
                document.getElementById('nav-view-questions').style.display = 'none';
                document.getElementById('admin-section').style.display = 'none';
            }
            if (!user || !user.name) {
                loginDiv.style.display = 'block';
                infoDiv.style.display = 'none';
                logoutBtn.style.display = 'none';
                document.getElementById('progress-report').style.display = 'none';
                document.getElementById('improvement-suggestions').style.display = 'none';
            } else {
                loginDiv.style.display = 'none';
                infoDiv.style.display = 'block';
                logoutBtn.style.display = 'inline-block';
                document.getElementById('progress-report').style.display = 'block';
                document.getElementById('improvement-suggestions').style.display = 'block';
                loadProfile();
            }
            renderWelcomeBanner();
        }

        // Store login time on profile creation
        document.getElementById('profile-login-btn').onclick = function() {
            const name = document.getElementById('profile-name-input').value.trim();
            if (!name) {
                alert('Please enter your name.');
                return;
            }
            const now = new Date();
            let allLogins = JSON.parse(localStorage.getItem('allLogins')) || {};
            allLogins[name] = now.toLocaleString();
            localStorage.setItem('allLogins', JSON.stringify(allLogins));
            localStorage.setItem('userProfile', JSON.stringify({name, tests: []}));
            showProfileUI();
            // If name is 'themastyogi', treat as admin
            if (name.toLowerCase() === 'themastyogi') {
                isAdminLoggedIn = true;
                document.getElementById('nav-admin').style.display = 'inline-block';
                document.getElementById('nav-view-questions').style.display = 'inline-block';
            }
            renderWelcomeBanner();
        };
        document.getElementById('logout-btn').onclick = function() {
            localStorage.removeItem('userProfile');
            showProfileUI();
            isAdminLoggedIn = false;
            document.getElementById('nav-view-questions').style.display = 'none';
            document.getElementById('admin-section').style.display = 'none';
            renderWelcomeBanner();
        };

        // Render welcome banner
        function renderWelcomeBanner() {
            let user = JSON.parse(localStorage.getItem('userProfile'));
            let allLogins = JSON.parse(localStorage.getItem('allLogins')) || {};
            let infoDiv = document.getElementById('nav-user-info');
            if (!user || !user.name) {
                infoDiv.innerHTML = '';
                return;
            }
            let loginTime = allLogins[user.name] || '-';
            let html = `<span style='color:#222;'>${user.name}</span> <span style='color:#888;font-size:0.97em;'>(Login: ${loginTime})</span>`;
            if (user.name.toLowerCase() === 'themastyogi') {
                // Admin summary
                let allProfiles = Object.keys(allLogins);
                let userTests = JSON.parse(localStorage.getItem('userTests')) || {};
                let testCount = 0;
                allProfiles.forEach(profile => {
                    let tests = (userTests[profile] || []);
                    testCount += tests.length;
                });
                html += ` &nbsp;|&nbsp; <span style='color:#357ab8;'>Admin: ${allProfiles.length} profiles, ${testCount} tests</span>`;
            }
            infoDiv.innerHTML = html;
        }

        // Save user test history in userTests for admin summary
        function saveUserTestHistory(name, testObj) {
            let userTests = JSON.parse(localStorage.getItem('userTests')) || {};
            if (!userTests[name]) userTests[name] = [];
            userTests[name].push(testObj);
            localStorage.setItem('userTests', JSON.stringify(userTests));
        }
        // Patch test submission to save to userTests for admin
        // (Find your test submit logic and add: saveUserTestHistory(user.name, {score, ...}));
        document.getElementById('profile-login-btn').onclick = function() {
            const name = document.getElementById('profile-name-input').value.trim();
            if (!name) {
                alert('Please enter your name.');
                return;
            }
            localStorage.setItem('userProfile', JSON.stringify({name, tests: []}));
            showProfileUI();
            // If name is 'themastyogi', treat as admin
            if (name.toLowerCase() === 'themastyogi') {
                isAdminLoggedIn = true;
                document.getElementById('nav-admin').style.display = 'inline-block';
                document.getElementById('nav-view-questions').style.display = 'inline-block';
            }
        };
        document.getElementById('logout-btn').onclick = function() {
            localStorage.removeItem('userProfile');
            showProfileUI();
            // Hide admin features on logout
            isAdminLoggedIn = false;
            document.getElementById('nav-view-questions').style.display = 'none';
            document.getElementById('admin-section').style.display = 'none';
        };

        // User profile and progress
        function loadProfile() {
            let user = JSON.parse(localStorage.getItem('userProfile')) || {name: 'Student', tests: []};
            document.getElementById('profile-info').innerHTML = `<b>Name:</b> ${user.name}`;
            // Progress report
            let report = '';
            if (user.tests.length === 0) {
                report = 'No tests taken yet.';
            } else {
                let total = user.tests.length;
                let avg = (user.tests.reduce((a, t) => a + t.score, 0) / total).toFixed(2);
                report = `<b>Tests Taken:</b> ${total}<br><b>Average Score:</b> ${avg}%`;
            }
            document.getElementById('progress-report').innerHTML = report;
            // Improvement suggestion
            let suggestion = '';
            if (user.tests.length > 0) {
                let last = user.tests[user.tests.length - 1];
                if (last.score < 60) suggestion = 'Focus on basics and review your mistakes.';
                else if (last.score < 80) suggestion = 'Good job! Practice more to improve.';
                else suggestion = 'Excellent! Keep up the great work.';
            }
            document.getElementById('improvement-suggestions').innerHTML = suggestion;
        }
        showProfileUI();

        // Subjects (static for now)
        const subjects = [
            'Indian Polity and Governance',
            'Current Affairs',
            'History of India',
            'Indian and World Geography',
            'Comprehension',
            'Interpersonal Skills and Communication',
            'Logical Reasoning and Analytical Ability',
            'Decision Making and Problem Solving',
            'General Mental Ability',
            'Numerical and mental ability tests.',
            'Questions on basic arithmetic operations and their applications.',
            'Basic Numeracy and Data Interpretation',
            'Numbers and their relations.',
            'UPPCS',
            'UPPSC',
            'UPARP',
            'PMP'
        ];
        const subjectSelect = document.getElementById('subject-select');
        subjects.forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            subjectSelect.appendChild(opt);
        });
        // For view questions subject select
        const viewQuestionsSubject = document.getElementById('view-questions-subject');
        subjects.forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            viewQuestionsSubject.appendChild(opt);
        });

        // Question bank (admin upload)
        let questionBank = JSON.parse(localStorage.getItem('questionBank')) || {};
        function handleFileUpload(evt) {
            const file = document.getElementById('question-file-input').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                let text = e.target.result;
                let lines = text.split(/\r?\n/).filter(l => l.trim());
                let subject = prompt('Enter subject for these questions:', subjects[0]);
                if (!subject) return;
                if (!questionBank[subject]) questionBank[subject] = [];
                lines.forEach(line => {
                    let parts = line.split(','); // CSV: question,optionA,optionB,optionC,optionD,answer[,explanation]
                    if (parts.length >= 6) {
                        let options = parts.slice(1,5);
                        let ans = parts[5].trim();
                        // If answer is a letter, convert to option text
                        let answer = ans;
                        if (["A","B","C","D"].includes(ans.toUpperCase())) {
                            const idx = {A:0,B:1,C:2,D:3}[ans.toUpperCase()];
                            answer = options[idx];
                        }
                        let explanation = parts.length > 6 ? parts[6].trim() : '';
                        questionBank[subject].push({
                            question: parts[0],
                            options: options,
                            answer: answer,
                            explanation: explanation
                        });
                    }
                });
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
                document.getElementById('upload-status').textContent = `Uploaded ${lines.length} questions to ${subject}.`;
            };
            reader.readAsText(file);
        }
        document.getElementById('upload-questions-btn').onclick = handleFileUpload;

        // Download Excel/CSV template
        document.getElementById('download-template-btn').onclick = function() {
            const csv = 'question,optionA,optionB,optionC,optionD,answer,explanation\nSample Question?,A,B,C,D,A,This is an explanation';
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'question_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // Manual question entry
        const manualSubjectSelect = document.getElementById('manual-subject-select');
        function updateManualSubjectOptions() {
            manualSubjectSelect.innerHTML = '';
            subjects.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                manualSubjectSelect.appendChild(opt);
            });
        }
        updateManualSubjectOptions();
        document.getElementById('manual-question-form').onsubmit = function(e) {
            e.preventDefault();
            const subject = manualSubjectSelect.value;
            const question = document.getElementById('manual-question').value.trim();
            const optionA = document.getElementById('manual-optionA').value.trim();
            const optionB = document.getElementById('manual-optionB').value.trim();
            const optionC = document.getElementById('manual-optionC').value.trim();
            const optionD = document.getElementById('manual-optionD').value.trim();
            const answerLetter = document.getElementById('manual-answer').value;
            if (!subject || !question || !optionA || !optionB || !optionC || !optionD || !answerLetter) {
                document.getElementById('manual-add-status').textContent = 'Please fill all fields.';
                return;
            }
            let answer = '';
            if (answerLetter === 'A') answer = optionA;
            else if (answerLetter === 'B') answer = optionB;
            else if (answerLetter === 'C') answer = optionC;
            else if (answerLetter === 'D') answer = optionD;
            if (!questionBank[subject]) questionBank[subject] = [];
            questionBank[subject].push({
                question,
                options: [optionA, optionB, optionC, optionD],
                answer: answer,
                explanation: document.getElementById('manual-explanation').value.trim()
            });
            localStorage.setItem('questionBank', JSON.stringify(questionBank));
            document.getElementById('manual-add-status').textContent = 'Question added!';
            document.getElementById('manual-question-form').reset();
        };

        // View Questions (admin)
        function renderQuestionsTable() {
            const subj = viewQuestionsSubject.value;
            let questions = (JSON.parse(localStorage.getItem('questionBank')) || {})[subj] || [];
            let html = `<table border='1' style='width:100%;border-collapse:collapse;'>
                <tr><th>#</th><th>Question</th><th>Options</th><th>Correct Answer</th><th>Explanation</th><th>Actions</th></tr>`;
            questions.forEach((q, i) => {
                html += `<tr data-idx='${i}'>
<td>${i+1}</td>
<td class='q-question'>${q.question}</td>
<td class='q-options'>${q.options.map((o,j)=>String.fromCharCode(65+j)+'. '+o).join('<br>')}</td>
<td class='q-answer'>${q.answer}</td>
<td class='q-explanation'>${q.explanation||''}</td>
<td>
  <button class='edit-btn'>Edit</button>
  <button class='delete-btn'>Delete</button>
  <button class='save-btn' style='display:none;'>Save</button>
  <button class='cancel-btn' style='display:none;'>Cancel</button>
</td>
</tr>`;
            });
            html += '</table>';
            document.getElementById('questions-table-container').innerHTML = html;
            // Add event listeners for edit/delete/save/cancel
            const table = document.getElementById('questions-table-container');
            table.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = function() {
                    const idx = parseInt(btn.closest('tr').dataset.idx);
                    if (confirm('Delete this question?')) {
                        let qb = JSON.parse(localStorage.getItem('questionBank')) || {};
                        let subj = viewQuestionsSubject.value;
                        qb[subj].splice(idx,1);
                        localStorage.setItem('questionBank', JSON.stringify(qb));
                        renderQuestionsTable();
                    }
                };
            });
            table.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = function() {
                    const tr = btn.closest('tr');
                    btn.style.display = 'none';
                    tr.querySelector('.delete-btn').style.display = 'none';
                    tr.querySelector('.save-btn').style.display = 'inline-block';
                    tr.querySelector('.cancel-btn').style.display = 'inline-block';
                    // Make editable
                    const q = tr.querySelector('.q-question');
                    const o = tr.querySelector('.q-options');
                    const a = tr.querySelector('.q-answer');
                    const e = tr.querySelector('.q-explanation');
                    q.innerHTML = `<input type='text' value="${q.textContent.replace(/"/g, '&quot;')}">`;
                    // options as textarea, one per line
                    o.innerHTML = `<textarea rows='4'>${o.innerHTML.replace(/<br>/g,'\n').replace(/<[^>]+>/g,'')}</textarea>`;
                    a.innerHTML = `<input type='text' value="${a.textContent.replace(/"/g, '&quot;')}">`;
                    e.innerHTML = `<input type='text' value="${e.textContent.replace(/"/g, '&quot;')}">`;
                }
            });
            table.querySelectorAll('.cancel-btn').forEach(btn => {
                btn.onclick = function() { renderQuestionsTable(); };
            });
            table.querySelectorAll('.save-btn').forEach(btn => {
                btn.onclick = function() {
                    const tr = btn.closest('tr');
                    const idx = parseInt(tr.dataset.idx);
                    const q = tr.querySelector('.q-question input').value.trim();
                    const o = tr.querySelector('.q-options textarea').value.trim().split('\n').map(x=>x.trim()).filter(x=>x);
                    const a = tr.querySelector('.q-answer input').value.trim();
                    const e = tr.querySelector('.q-explanation input').value.trim();
                    if (!q || o.length!==4 || !a) { alert('Fill all fields (4 options required)'); return; }
                    let qb = JSON.parse(localStorage.getItem('questionBank')) || {};
                    let subj = viewQuestionsSubject.value;
                    qb[subj][idx] = {question:q, options:o, answer:a, explanation:e};
                    localStorage.setItem('questionBank', JSON.stringify(qb));
                    renderQuestionsTable();
                }
            });
        }
        viewQuestionsSubject.onchange = renderQuestionsTable;

        // Test History (user)
        function renderTestHistory() {
            let user = JSON.parse(localStorage.getItem('userProfile')) || {name: 'Student', tests: []};
            let historyDiv = document.getElementById('test-history-list');
            let detailDiv = document.getElementById('test-detail-container');
            if (!user.tests.length) {
                historyDiv.innerHTML = 'No tests taken yet.';
                detailDiv.innerHTML = '';
                return;
            }
            let html = '<ul>';
            user.tests.forEach((t, i) => {
                html += `<li><button onclick='showTestDetail(${i})'>${t.subject} - ${t.mode||'normal'} - Score: ${t.score}</button></li>`;
            });
            html += '</ul>';
            historyDiv.innerHTML = html;
            detailDiv.innerHTML = '';
        }
        window.showTestDetail = function(idx) {
            let user = JSON.parse(localStorage.getItem('userProfile')) || {name: 'Student', tests: []};
            let t = user.tests[idx];
            let subject = t.subject;
            let questions = (JSON.parse(localStorage.getItem('questionBank')) || {})[subject] || [];
            let html = `<h3>${subject} - ${t.mode||'normal'} - Score: ${t.score}</h3><table border='1' style='width:100%;border-collapse:collapse;'><tr><th>#</th><th>Question</th><th>Options</th><th>Your Answer</th><th>Correct Answer</th><th>Explanation</th></tr>`;
            // If test was taken with only a subset of questions, try to match up to that many
            for(let i=0; i<t.correct + t.wrong + t.skipped; i++) {
                let q = questions[i] || {};
                let userAns = (t.userAnswers && t.userAnswers[i]) || '';
                html += `<tr><td>${i+1}</td><td>${q.question||''}</td><td>${(q.options||[]).map((o,j)=>String.fromCharCode(65+j)+'. '+o).join('<br>')}</td><td>${userAns||'Skipped'}</td><td>${q.answer||''}</td><td>${q.explanation||''}</td></tr>`;
            }
            html += '</table>';
            document.getElementById('test-detail-container').innerHTML = html;
        }

        // --- SPA NAVIGATION BUTTON HANDLERS ---
        // (Removed duplicate navigation and login logic. Use only the main SPA navigation and user profile logic.)

        // Admin Evaluation Settings (save timer)
        document.getElementById('admin-eval-form').onsubmit = function(e) {
            e.preventDefault();
            const duration = parseInt(document.getElementById('test-duration').value) || 30;
            let evalSettings = JSON.parse(localStorage.getItem('evalSettings')) || {};
            evalSettings.testDuration = duration;
            evalSettings.negMarksDeduct = parseFloat(document.getElementById('neg-marks-deduct').value) || 1;
            evalSettings.negMarksCount = parseInt(document.getElementById('neg-marks-count').value) || 3;
            evalSettings.upscMarksCorrect = parseFloat(document.getElementById('upsc-marks-correct').value) || 2;
            evalSettings.upscMarksWrong = parseFloat(document.getElementById('upsc-marks-wrong').value) || 0.66;
            localStorage.setItem('evalSettings', JSON.stringify(evalSettings));
            document.getElementById('admin-eval-status').textContent = 'Settings saved!';
            setTimeout(()=>document.getElementById('admin-eval-status').textContent='', 1500);
        };

        // Timer and single-question navigation logic
        let timerInterval = null;
        let timerSeconds = 0;
        let currentIndex = 0;
        let answers = [];

        function startTimer(duration) {
            timerSeconds = duration * 60;
            updateTimerDisplay();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    submitTest(true);
                }
            }, 1000);
        }
        function updateTimerDisplay() {
            const min = Math.floor(timerSeconds / 60).toString().padStart(2,'0');
            const sec = (timerSeconds % 60).toString().padStart(2,'0');
            document.getElementById('timer-display').textContent = `Time Left: ${min}:${sec}`;
        }
        function showQuestion(idx) {
            currentIndex = idx;
            const q = window.currentQuestions[idx];
            document.getElementById('question-progress').textContent = `Question ${idx+1} / ${window.currentQuestions.length}`;
            // Render question
            let html = `<b>Q${idx+1}:</b> ${q.question}<div class='question-options'>`;
            q.options.forEach((opt, oidx) => {
                let id = `q${idx}o${oidx}`;
                let checked = (answers[idx] === opt) ? 'checked' : '';
                html += `<div class='option-row'><input type='radio' name='q${idx}' value='${opt}' id='${id}' ${checked}><label for='${id}'>${opt}</label></div>`;
            });
            html += `</div>`;
            document.getElementById('question-container').innerHTML = html;
            // Nav buttons
            document.getElementById('prev-btn').disabled = idx === 0;
            document.getElementById('skip-btn').disabled = idx === window.currentQuestions.length-1;
            document.getElementById('save-next-btn').style.display = idx === window.currentQuestions.length-1 ? 'none' : 'inline-block';
            document.getElementById('submit-test-btn').style.display = idx === window.currentQuestions.length-1 ? 'inline-block' : 'none';
        }
        document.getElementById('prev-btn').onclick = function() {
            if (currentIndex > 0) showQuestion(currentIndex-1);
        };
        document.getElementById('skip-btn').onclick = function() {
            if (currentIndex < window.currentQuestions.length-1) {
                answers[currentIndex] = 'Skipped';
                showQuestion(currentIndex+1);
            }
        };
        document.getElementById('save-next-btn').onclick = function() {
            saveCurrentAnswer();
            if (currentIndex < window.currentQuestions.length-1) showQuestion(currentIndex+1);
        };
        function saveCurrentAnswer() {
            let opts = document.getElementsByName(`q${currentIndex}`);
            let ans = '';
            opts.forEach(opt => { if (opt.checked) ans = opt.value; });
            answers[currentIndex] = ans || '';
        }
        function submitTest(auto) {
            clearInterval(timerInterval);
            // Fill unanswered/skipped
            for(let i=0; i<window.currentQuestions.length; i++) {
                if (!answers[i]) answers[i] = 'Skipped';
            }
            // Simple scoring: count correct answers
            let correct = 0;
            window.currentQuestions.forEach((q, idx) => {
                if (answers[idx] === q.answer) correct++;
            });
            let score = Math.round((correct / window.currentQuestions.length) * 100);
            alert(auto ? 'Time is up! Submitting test.' : `Test submitted! Score: ${score}%`);
            // Save to user profile
            let user = JSON.parse(localStorage.getItem('userProfile')) || {name: 'Student', tests: []};
            user.tests.push({subject: subjectSelect.value, score});
            localStorage.setItem('userProfile', JSON.stringify(user));
            // Save to admin dashboard
            saveUserTestHistory(user.name, {subject: subjectSelect.value, score, date: new Date().toLocaleString()});
            loadProfile();
            renderWelcomeBanner();
            showSection('profile');
        }

        // Render Test function (needed for Start Test)
        function renderTest() {
            const container = document.getElementById('question-container');
            container.innerHTML = '';
            window.currentQuestions.forEach((q, idx) => {
                let qDiv = document.createElement('div');
                qDiv.innerHTML = `<b>Q${idx+1}:</b> ${q.question}`;
                q.options.forEach((opt, oidx) => {
                    let id = `q${idx}o${oidx}`;
                    qDiv.innerHTML += `<br><input type='radio' name='q${idx}' value='${opt}' id='${id}'><label for='${id}'>${opt}</label>`;
                });
                container.appendChild(qDiv);
                container.appendChild(document.createElement('hr'));
            });
            document.getElementById('submit-test-btn').style.display = 'block';
        }

        // Start Test button handler
        document.getElementById('start-test-btn').onclick = async function() {
            const subject = document.getElementById('subject-select').value;
            const evalMode = document.getElementById('eval-mode-select').value;
            const lang = document.getElementById('language-select').value;
            let questionBank = JSON.parse(localStorage.getItem('questionBank')) || {};
            let questions = questionBank[subject] || [];
            if (!questions.length) {
                alert('No questions for this subject!');
                return;
            }
            // Translation logic if Hindi selected
            if (lang === 'hi') {
                showSection('test');
                document.getElementById('question-container').innerHTML = '<b>Translating questions to Hindi, please wait...</b>';
                questions = await Promise.all(questions.map(async q => {
                    const translatedQ = await translateText(q.question, 'hi');
                    const translatedOpts = await Promise.all(q.options.map(opt => translateText(opt, 'hi')));
                    return {
                        ...q,
                        question: translatedQ,
                        options: translatedOpts,
                        answer: q.answer, // Note: answer is still in English, can improve if needed
                        explanation: q.explanation // Could also translate if desired
                    };
                }));
            }
            window.currentQuestions = questions.slice(); // use all questions
            window.selectedEvalMode = evalMode;
            answers = [];
            currentIndex = 0;
            // Get duration from settings
            let evalSettings = JSON.parse(localStorage.getItem('evalSettings')) || {testDuration:30};
            startTimer(evalSettings.testDuration || 30);
            showSection('test');
            showQuestion(0);
        };
        // Google Translate API (demo, not for prod)
        async function translateText(text, targetLang) {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                return data[0][0][0];
            } catch (e) {
                return text + ' (translation error)';
            }
        }

    </script>
</body>
</html>
